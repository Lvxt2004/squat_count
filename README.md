# 深蹲计数系统

基于 AI 姿态识别的实时深蹲计数与评分系统，使用 MediaPipe 进行人体姿态检测，KNN 分类器进行姿态识别，DTW 动态时间规整算法进行动作质量评分。

## 功能特点

- **实时深蹲计数**：通过摄像头实时识别蹲下和站立状态，完成一次完整深蹲后自动计数
- **视频上传检测**：支持上传视频文件进行离线深蹲检测和评分
- **DTW 动作评分**：使用动态时间规整算法，将用户动作与标准动作对比，给出 0-100 分的质量评分
- **多角度支持**：支持正面、侧面、斜面三种面向摄像头的角度
- **全身检测**：自动检测用户全身是否在画面内，未检测到时显示警告提示
- **防抖机制**：使用滑动窗口防抖，避免姿态抖动导致的误计数

## 技术实现

### 姿态检测

使用 MediaPipe Pose 检测人体 33 个关键点，主要使用以下关键点：
- 肩部（左肩、右肩）
- 髋部（左髋、右髋）
- 膝盖（左膝、右膝）
- 脚踝（左踝、右踝）

### 姿态分类（站立/蹲下）

KNN 分类器，12 维特征：
- 肩部、髋部、膝盖到脚踝的归一化距离（3 维）
- 左右膝关节角度（髋-膝-踝）（2 维）
- 左右髋关节角度（肩-髋-膝）（2 维）
- 髋部、膝盖的相对高度比例（2 维）
- 躯干与大腿夹角（1 维）
- 平均膝盖角度、平均髋关节角度（2 维）

### 角度分类（正面/侧面/斜面）

KNN 分类器，2 维特征：
- 髋部连线在 XZ 平面（俯视图）与 X 轴的夹角
- 肩部连线在 XZ 平面（俯视图）与 X 轴的夹角

角度判断原理：
- **正面**：夹角接近 0°（肩部/髋部连线平行于 X 轴）
- **侧面**：夹角接近 90°（肩部/髋部连线垂直于 X 轴）
- **斜面**：夹角在 30°-60° 之间

### DTW 动作评分

使用动态时间规整（Dynamic Time Warping）算法评估深蹲动作质量：
1. 记录用户每次深蹲的动作序列（6 维特征：左右膝盖角度、左右髋关节角度、髋部相对高度、躯干大腿夹角）
2. 与预存的标准深蹲序列进行 DTW 距离计算
3. 根据距离映射到 0-100 分，距离越小分数越高

### 模型训练

- 使用 KNN（K-近邻）分类器
- GridSearchCV 自动搜索最优超参数（K 值、距离度量、权重方式）
- 5 折交叉验证确保模型泛化能力

## 项目结构

```
squat_count_opus/
├── app.py                # Flask Web 应用（实时检测 + 视频上传）
├── squat_counter.py      # 深蹲计数器核心逻辑（含 DTW 评分）
├── train_models.py       # 模型训练脚本
├── debug_features.py     # 特征调试工具
├── evaluate_scoring.py   # 评分系统评估工具
├── requirements.txt      # 依赖包列表
├── models/               # 训练好的模型
│   ├── pose_knn.pkl      # 姿态分类模型
│   ├── pose_scaler.pkl   # 姿态特征标准化器
│   ├── angle_knn.pkl     # 角度分类模型
│   └── angle_scaler.pkl  # 角度特征标准化器
├── data_csv/             # 训练数据
│   ├── csv_angle/        # 角度分类数据（正面/侧面/斜面 × 站立/蹲下）
│   └── csv_standard/     # DTW 标准动作序列（三个角度各一个标准深蹲）
└── templates/            # 前端页面
    ├── index.html        # 实时检测页面
    └── video.html        # 视频上传检测页面
```

## 安装与使用

### 安装依赖

```bash
pip install -r requirements.txt
```

### 训练模型（可选，已提供预训练模型）

```bash
python train_models.py
```

### 启动应用

```bash
python app.py
```

打开浏览器访问 http://localhost:5000

## 使用说明

### 实时检测模式

1. 确保摄像头可用
2. 站在摄像头前，保持全身在画面内
3. 进行深蹲动作，系统会自动计数并评分
4. 点击"重置计数"按钮可清零计数和评分

### 视频上传模式

1. 点击页面上的"切换到视频检测模式"链接
2. 上传包含深蹲动作的视频文件（支持 MP4、AVI、MOV、MKV、WebM）
3. 系统会自动分析视频并显示计数和评分结果

## 评分等级

| 分数 | 等级 | 说明 |
|------|------|------|
| 85-100 | 优秀 | 动作标准，节奏稳定 |
| 70-84 | 良好 | 动作较好，有小幅偏差 |
| 55-69 | 及格 | 动作基本正确，需要改进 |
| 0-54 | 需改进 | 动作偏差较大，建议参考标准动作 |